name: pre-commit

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.0'
    - name: Install Go tools
      run: |
        go install golang.org/x/tools/cmd/goimports@latest
        go install honnef.co/go/tools/cmd/staticcheck@latest
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v3
    - uses: pre-commit/action@v3.0.1

  goreleaser-build:
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.0'
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v4
      with:
        version: latest
        args: release --snapshot --clean --config .goreleaser.yml --skip=publish

  go-tests:
    runs-on: ubuntu-latest
    needs: pre-commit
    services:
      docker:
        image: docker:19.03.12
        options: --privileged # required for nested containers
        ports:
          - 2375:2375
        volumes:
          - /var/lib/docker
    steps:
    - name: Set up Docker environment
      run: |
        docker info
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.0'
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up SSH agent
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts
    - name: Run Go tests with retries
      env:
        TEST_GIT_TOKEN: ${{ secrets.TEST_GIT_TOKEN }}
      run: |
        eval $(ssh-agent -s)
        export SSH_AUTH_SOCK
        max_attempts=5
        attempt_num=1
        until [ $attempt_num -gt $max_attempts ]
        do
          echo "Attempt $attempt_num of $max_attempts"
          go test ./... && break || echo "Test failed. Retrying..."
          go test -tags web3 ./... && break || echo "Test with web3 tag failed. Retrying..."
          attempt_num=$((attempt_num + 1))
          if [ $attempt_num -gt $max_attempts ]
          then
            echo "All test attempts failed."
            exit 1
          fi
          sleep 5
        done

  js-tests:
    runs-on: ubuntu-latest
    needs: pre-commit
    services:
      docker:
        image: docker:19.03.12
        options: --privileged # required for nested containers
        ports:
          - 2375:2375
        volumes:
          - /var/lib/docker
    steps:
    - name: Set up Docker environment
      run: |
        docker info
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.0'
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Build mock servers
      run: |
        for project in "spore-drive" "taucorder"; do
          (
            cd pkg/$project/clients/mock
            go build .
          ) || exit 1
        done
    - name: Run JS/TS tests with retries
      run: |
        max_attempts=5
        for project in "pkg/spore-drive/clients/js" "pkg/taucorder/clients/js"; do
          attempt_num=1 
          (
            cd $project
            echo "Running tests for $project"
            npm i
            until [ $attempt_num -gt $max_attempts ]
            do
              echo "Attempt $attempt_num of $max_attempts"
              npm run test && break || echo "Test failed. Retrying..."
              attempt_num=$((attempt_num + 1))
              if [ $attempt_num -gt $max_attempts ]
              then
                echo "All test attempts failed for $project"
                exit 1
              fi
              sleep 5
            done
            # clean-up mock servers
            kill $(pgrep -f "mock") || true
          ) || exit 1
        done

  containerd-integration:
    runs-on: ubuntu-latest
    needs: pre-commit
    services:
      docker:
        image: docker:19.03.12
        options: --privileged
        ports:
          - 2375:2375
        volumes:
          - /var/lib/docker
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.0'
      - name: Set up Docker environment
        run: docker info

      # --- Rootful: install + start system containerd ---
      - name: Install and start containerd
        run: |
          sudo apt-get update
          sudo apt-get install -y containerd.io
          sudo systemctl start containerd
          sudo chmod 666 /run/containerd/containerd.sock

      # --- Rootless: install deps + subuid/subgid ---
      - name: Install rootless prerequisites
        run: |
          sudo apt-get install -y rootlesskit slirp4netns uidmap
          u="$(whoami)"
          grep -q "^${u}:" /etc/subuid || echo "${u}:100000:65536" | sudo tee -a /etc/subuid
          grep -q "^${u}:" /etc/subgid || echo "${u}:100000:65536" | sudo tee -a /etc/subgid

      # Run all containerd tests (unit + integration); integration tests require -tags=containerd_integration
      # Use runner's Docker (default socket); do not set DOCKER_HOST so NestedDocker tests can connect
      - name: Run containerd tests (unit + integration)
        run: |
          go test -tags=containerd_integration ./pkg/containers/backends/containerd \
            -count=1 -timeout 15m -v -p 1

  docker-integration:
    runs-on: ubuntu-latest
    needs: pre-commit
    services:
      docker:
        image: docker:19.03.12
        options: --privileged
        ports:
          - 2375:2375
        volumes:
          - /var/lib/docker
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.0'
      - name: Set up Docker environment
        run: docker info
      - name: Run Docker integration tests
        run: |
          go test -tags=docker_integration -run '_Integration$' ./pkg/containers/... \
            -timeout 15m -v -p 1

  discover-dream-packages:
    runs-on: ubuntu-latest
    needs: pre-commit
    outputs:
      packages: ${{ steps.discover.outputs.packages }}
    steps:
      - uses: actions/checkout@v3
      - name: Discover major folders with dreaming tests
        id: discover
        run: |
          MAJOR_DIRS=$(grep -rl '//go:build dreaming' --include='*_test.go' . \
            | sed 's|^\./||' \
            | while read f; do
                dir=$(dirname "$f")
                top=$(echo "$dir" | cut -d'/' -f1)
                if [ "$top" = "services" ]; then
                  echo "$dir" | cut -d'/' -f1-2
                else
                  echo "$top"
                fi
              done \
            | sort -u)
          if [ -z "$MAJOR_DIRS" ]; then
            echo "packages=[]" >> "$GITHUB_OUTPUT"
          else
            JSON=$(echo "$MAJOR_DIRS" | jq -R -s -c 'split("\n") | map(select(length>0))')
            echo "packages=$JSON" >> "$GITHUB_OUTPUT"
          fi
          echo "Discovered: $MAJOR_DIRS"

  dream-based-tests:
    runs-on: ubuntu-latest
    needs: [pre-commit, discover-dream-packages]
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover-dream-packages.outputs.packages) }}
    services:
      docker:
        image: docker:19.03.12
        options: --privileged
        ports:
          - 2375:2375
        volumes:
          - /var/lib/docker
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.0'
      - name: Set up Docker environment
        run: docker info
      - name: Set up SSH agent
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Run dreaming tests (${{ matrix.package }})
        env:
          TEST_GIT_TOKEN: ${{ secrets.TEST_GIT_TOKEN }}
        run: |
          eval $(ssh-agent -s)
          export SSH_AUTH_SOCK
          max_attempts=5
          attempt_num=1
          until [ $attempt_num -gt $max_attempts ]
          do
            echo "Attempt $attempt_num of $max_attempts"
            go test -tags=dreaming -run '_Dreaming$' -p 1 ./${{ matrix.package }}/... -timeout 20m && break || echo "Dream tests failed. Retrying..."
            attempt_num=$((attempt_num + 1))
            if [ $attempt_num -gt $max_attempts ]
            then
              echo "All dream test attempts failed for ${{ matrix.package }}."
              exit 1
            fi
            sleep 5
          done

  raft-integration:
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.0'
      - name: Run raft integration tests
        run: go test -tags=raft_integration -run '_Integration$' ./pkg/raft/... -timeout 15m -v -p 1

  py-tests:
    runs-on: ubuntu-latest
    needs: pre-commit
    steps:
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25.0'
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Build mock servers
      run: |
        for project in "spore-drive" "taucorder"; do
          (
            cd pkg/$project/clients/mock
            go build .
          ) || exit 1
        done
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Run Python tests with retries
      run: |
        max_attempts=5
        attempt_num=1
        (
          cd pkg/spore-drive/clients/py
          echo "Creating Python virtual environment"
          python -m venv venv
          source venv/bin/activate
          echo "Installing Python dependencies"
          pip install --upgrade pip
          pip install -e .[dev]
          pip install -r example/requirements.txt
          echo "Running Python tests for spore-drive"
          until [ $attempt_num -gt $max_attempts ]
          do
            echo "Attempt $attempt_num of $max_attempts"
            python -m pytest tests/ -v --cov=spore_drive --cov-report=term-missing && break || echo "Test failed. Retrying..."
            attempt_num=$((attempt_num + 1))
            if [ $attempt_num -gt $max_attempts ]
            then
              echo "All test attempts failed for Python spore-drive"
              exit 1
            fi
            sleep 5
          done
          # clean-up mock servers
          kill $(pgrep -f "mock") || true
        ) || exit 1